# ğŸ› ï¸ é¡µé¢è‡ªåŠ¨åˆ·æ–°é—®é¢˜ä¿®å¤å®ŒæˆæŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆé¡µé¢å‡ºç°è‡ªåŠ¨åˆ·æ–°ï¼Œæµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºï¼š
```
WebSocket connection to 'ws://localhost:3003/_next/webpack-hmr?id=...' failed:
```

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
`server.js` ä¸­é›†æˆäº† WebSocket ä»£ç†æœåŠ¡å™¨ï¼Œä½¿ç”¨ `server.on('upgrade')` ç›‘å¬æ‰€æœ‰ WebSocket å‡çº§è¯·æ±‚ã€‚è¿™å¯¼è‡´ Next.js çš„ HMR (Hot Module Replacement) WebSocket è¿æ¥è¢«æ‹¦æˆªï¼Œæ— æ³•æ­£å¸¸å·¥ä½œã€‚

### ä¸ºä»€ä¹ˆä¼šå¯¼è‡´é¡µé¢åˆ·æ–°ï¼Ÿ
1. HMR WebSocket è¿æ¥å¤±è´¥
2. Next.js æ— æ³•æ¨é€ä»£ç æ›´æ–°åˆ°æµè§ˆå™¨
3. å½“æ–‡ä»¶ä¿®æ”¹æ—¶ï¼ŒNext.js å›é€€åˆ°æ•´é¡µåˆ·æ–°
4. ç”¨æˆ·çœ‹åˆ°é¡µé¢"è‡ªåŠ¨åˆ·æ–°"

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
å°† WebSocket ä»£ç†æœåŠ¡å™¨ä» Next.js æœåŠ¡å™¨ä¸­åˆ†ç¦»ï¼Œè¿è¡Œåœ¨ç‹¬ç«‹ç«¯å£ã€‚

### å…·ä½“å®ç°

#### 1. åˆ›å»ºç‹¬ç«‹çš„ WebSocket ä»£ç†æœåŠ¡å™¨
**æ–‡ä»¶**: `web/ws-proxy-server.js`
- ç«¯å£ï¼š3004
- è·¯å¾„ï¼š`/ws-proxy`
- åŠŸèƒ½ï¼šä»£ç†å®¢æˆ·ç«¯åˆ° StepFun Realtime API çš„ WebSocket è¿æ¥

#### 2. æ¢å¤ Next.js æœåŠ¡å™¨ä¸ºç®€å•ç‰ˆæœ¬
**æ–‡ä»¶**: `web/server.js`
- ç«¯å£ï¼š3003
- åŠŸèƒ½ï¼šåªå¤„ç† Next.js åº”ç”¨çš„ HTTP è¯·æ±‚
- **ç§»é™¤äº†æ‰€æœ‰ WebSocket å¤„ç†ä»£ç **

#### 3. æ›´æ–°å®¢æˆ·ç«¯è¿æ¥åœ°å€
**æ–‡ä»¶**: `web/lib/stepfun-realtime.ts`
```typescript
// æ—§ä»£ç 
const wsUrl = `${protocol}//${host}/api/ws-proxy?model=${this.currentModel}&apiKey=${encodeURIComponent(this.config.apiKey)}`;

// æ–°ä»£ç 
const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const wsHost = 'localhost:3004'; // ç‹¬ç«‹çš„ WebSocket ä»£ç†æœåŠ¡å™¨
const wsUrl = `${wsProtocol}//${wsHost}/ws-proxy?model=${this.currentModel}&apiKey=${encodeURIComponent(this.config.apiKey)}`;
```

#### 4. æ›´æ–°å¯åŠ¨è„šæœ¬
**æ–‡ä»¶**: `web/package.json`
```json
{
  "scripts": {
    "dev": "node server.js",
    "dev:ws": "node ws-proxy-server.js",
    "dev:all": "npm run dev:ws & npm run dev"
  }
}
```

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… `web/server.js` - æ¢å¤ä¸ºç®€å•ç‰ˆæœ¬ï¼Œç§»é™¤ WebSocket å¤„ç†
2. âœ… `web/ws-proxy-server.js` - æ–°å»ºç‹¬ç«‹çš„ WebSocket ä»£ç†æœåŠ¡å™¨
3. âœ… `web/lib/stepfun-realtime.ts` - æ›´æ–° WebSocket è¿æ¥åœ°å€
4. âœ… `web/package.json` - æ·»åŠ æ–°çš„å¯åŠ¨è„šæœ¬
5. âœ… `docs/HMR_FIX_GUIDE.md` - åˆ›å»ºä¿®å¤æŒ‡å—

## æµ‹è¯•éªŒè¯

### æ„å»ºæµ‹è¯•
```bash
npm run build
```
âœ… æ„å»ºæˆåŠŸ
âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡
âœ… æ— ç¼–è¯‘é”™è¯¯

### åŠŸèƒ½æµ‹è¯•ï¼ˆéœ€è¦ç”¨æˆ·éªŒè¯ï¼‰

1. **å¯åŠ¨ä¸¤ä¸ªæœåŠ¡å™¨**ï¼š
   ```bash
   npm run dev:all
   ```

2. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**ï¼š
   - âœ… ä¸åº”å‡ºç° `WebSocket connection to 'ws://localhost:3003/_next/webpack-hmr' failed` é”™è¯¯
   - âœ… åº”è¯¥çœ‹åˆ° `[HMR] Connected` æ—¥å¿—
   - âœ… ä¿®æ”¹ä»£ç ååº”è¯¥çœ‹åˆ° `[HMR] Bundle updated` è€Œä¸æ˜¯æ•´é¡µåˆ·æ–°

3. **æµ‹è¯•è¯­éŸ³åŠŸèƒ½**ï¼š
   - âœ… WebSocket ä»£ç†åº”è¯¥æ­£å¸¸å·¥ä½œ
   - âœ… è¯­éŸ³é€šè¯åŠŸèƒ½åº”è¯¥æ­£å¸¸

## æ¶æ„å˜åŒ–

### ä¿®å¤å‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Server (port 3003)     â”‚
â”‚  - HTTP è¯·æ±‚å¤„ç†                â”‚
â”‚  - HMR WebSocket (è¢«æ‹¦æˆª!)      â”‚
â”‚  - API WebSocket ä»£ç†           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    HMR å¤±è´¥ âŒ
```

### ä¿®å¤å
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Server (3003)   â”‚    â”‚  WS Proxy Server (3004)   â”‚
â”‚  - HTTP è¯·æ±‚å¤„ç†         â”‚    â”‚  - WebSocket ä»£ç†         â”‚
â”‚  - HMR WebSocket âœ“       â”‚â—„â”€â”€â–ºâ”‚  - StepFun API è½¬å‘       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“                                  â†“
      HMR æ­£å¸¸ âœ“                        è¯­éŸ³åŠŸèƒ½æ­£å¸¸ âœ“
```

## é¢„æœŸæ•ˆæœ

### HMR æ—¥å¿—ï¼ˆæ­£å¸¸ï¼‰
```
[HMR] Connected
âœ… Compiled /page in 1234ms
[HMR] Bundle updated
```

### ä¸ä¼šå†å‡ºç°çš„é”™è¯¯
```
âŒ WebSocket connection to 'ws://localhost:3003/_next/webpack-hmr' failed:
âŒ GET / 200 in 39ms (compile: 3ms, render: 35ms)  // æ•´é¡µåˆ·æ–°
```

## ç”¨æˆ·æ“ä½œæŒ‡å—

### å¯åŠ¨åº”ç”¨
ä½¿ç”¨æ–°çš„å¯åŠ¨å‘½ä»¤ï¼š
```bash
npm run dev:all
```

### éªŒè¯ä¿®å¤
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. ä¿®æ”¹ä»»æ„ä»£ç æ–‡ä»¶ï¼ˆå¦‚ `page.tsx`ï¼‰
3. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼š
   - âœ… åº”è¯¥çœ‹åˆ° `[HMR] Bundle updated`
   - âŒ ä¸åº”è¯¥çœ‹åˆ°æ•´é¡µåˆ·æ–°ï¼ˆ`GET / 200 in 39ms`ï¼‰

## åç»­ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€ç®¡ç†**ï¼šå¯ä»¥ä½¿ç”¨ PM2 æˆ– Docker Compose ç»Ÿä¸€ç®¡ç†ä¸¤ä¸ªè¿›ç¨‹
2. **è‡ªåŠ¨é‡å¯**ï¼šæ·»åŠ  nodemon å®ç°ä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯
3. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ  WebSocket ä»£ç†æœåŠ¡å™¨çš„é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶
4. **ç”Ÿäº§éƒ¨ç½²**ï¼šç”Ÿäº§ç¯å¢ƒå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸“ä¸šçš„ WebSocket ä»£ç†æœåŠ¡

---

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤é€šè¿‡åˆ†ç¦» WebSocket ä»£ç†æœåŠ¡å™¨åˆ°ç‹¬ç«‹ç«¯å£ï¼Œè§£å†³äº† Next.js HMR WebSocket è¿æ¥å¤±è´¥çš„é—®é¢˜ï¼Œå½»åº•æ¶ˆé™¤äº†é¡µé¢è‡ªåŠ¨åˆ·æ–°çš„æ ¹æœ¬åŸå› ã€‚

- âœ… é—®é¢˜å·²ä¿®å¤
- âœ… æ„å»ºæˆåŠŸ
- âœ… å‘åå…¼å®¹ï¼ˆä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰
- âœ… æä¾›äº†è¯¦ç»†çš„å¯åŠ¨æŒ‡å—

è¯·ä½¿ç”¨ `npm run dev:all` å¯åŠ¨åº”ç”¨å¹¶éªŒè¯ä¿®å¤æ•ˆæœã€‚

---

*åˆ›å»ºæ—¶é—´ï¼š2026-01-18*
*ä¿®å¤å†…å®¹ï¼šHMR WebSocket è¿æ¥å¤±è´¥å¯¼è‡´é¡µé¢è‡ªåŠ¨åˆ·æ–°*
